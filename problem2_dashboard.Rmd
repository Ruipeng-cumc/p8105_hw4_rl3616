---
title: "Problem 2 Flexdashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(flexdashboard)
library(p8105.datasets)

data("instacart")
```

```{r}
instacart |> 
  count(department) |> 
  mutate(department = fct_reorder(department, n)) |> 
  plot_ly(
  x = ~department, 
  y = ~n,
  color = ~department,
  type = "bar", 
  colors = "viridis"
) |> 
  layout(
    xaxis = list(title = "Department Name"),
    yaxis = list(title = "Total Number of Orders"),
    title = "Total Orders vs Avg days before Reorder by aisle"
  )

```

```{r}
instacart |>
  group_by(department, order_hour_of_day) |>
  summarise(n_orders = n(), .groups = "drop") |>
  plot_ly(
    x = ~order_hour_of_day,
    y = ~n_orders,
    color = ~department,
    type = "scatter",
    mode = "lines",
    text = ~paste0(
      "Department: ", department,
      "<br>Ordered hour: ", order_hour_of_day,
      "<br>Total orders: ", n_orders),
      hoverinfo = "text"
  ) |> 
  layout(
    xaxis = list(title = "Order Hours"),
    yaxis = list(title = "Number of Orders"),
    title = "Total Orders vs Avg days before Reorder by aisle"
  )
```

```{r}
aisle_summary <- instacart |>
  group_by(aisle) |>
  summarise(
    total_orders = n(),
    reorder_rate = mean(reordered, na.rm = TRUE),
    .groups = "drop"
  )

plot_ly(
  data = aisle_summary,
  x = ~total_orders,
  y = ~reorder_rate,
  type = "scatter",
  mode = "markers",
  color = ~aisle,
  text = ~paste0(
    "aisle: ", aisle,
    "<br>Total orders: ", total_orders,
    "<br>Reorder rate: ", scales::percent(reorder_rate, 0.1)),
  hoverinfo = "text"
) |>
  layout(
    xaxis = list(title = "Total Orders"),
    yaxis = list(title = "Reorder Rate"),
    title = "Reorder Rate vs Total Orders by aisle"
  )

```

```{r}
aisle_interval <- instacart |> 
  group_by(aisle) |> 
  summarise(
    avg_days = mean(days_since_prior_order, na.rm = TRUE),
    total_orders = n(),
    .groups = "drop"
  ) |> 
  arrange(avg_days)

plot_ly(
  data = aisle_interval,
  x = ~reorder(aisle, avg_days),
  y = ~avg_days,
  type = "bar",
  color = ~reorder(aisle, avg_days),
  colors = "viridis",
  text = ~paste0(
    "<br>Avg days: ", round(avg_days, 1),
    "<br>Total orders: ", total_orders
  ),
  hoverinfo = "text"
) |> 
  layout(
    title = "Average Days Since Prior Order by Aisle",
    xaxis = list(title = "Aisle", tickangle = -45),
    yaxis = list(title = "Average Days Between Orders"),
    margin = list(b = 120)
  )
```


```{r}
plot_ly(
  data = aisle_interval,
  x = ~total_orders,
  y = ~avg_days,
  type = "scatter",
  mode = "markers",
  color = ~aisle,
  colors = "viridis",
  text = ~paste0(
    "<br>Total Orders: ", total_orders,
    "<br>Avg days before Reorder: ", round(avg_days,2)
  ),
  hoverinfo = "text"
) |> 
  layout(
    xaxis = list(title = "Total Orders"),
    yaxis = list(title = "Avg days before Reorder"),
    title = "Total Orders vs Avg days before Reorder by aisle"
  )
```
